<!doctype html>
<meta charset="utf-8">
<title>New_Zoom_Pixijs</title>

<body>


<script src="./library/plugins/pixi.js/bin/pixi.js"></script>
<script src="./library/spriteUtilities/bin/spriteUtilities.js"></script>
<script src="./library/tink/bin/tink.js"></script>
<script src="./library/scaleToWindow/scaleToWindow.js"></script>
<script src="./library/bump/bin/bump.js"></script>
<script src="./library/pixitiled/bin/pixi-tiled.js"></script>
<script src="./library/plugins/json3/json3.min.js"></script>
<script src="./library/plugins/json3/jquery-3.1.1.min.js"></script>
<script src="./library/js/initGame.js"></script>

<script>

//
let Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Texture = PIXI.Texture,
    Graphics = PIXI.Graphics,
    Text = PIXI.Text,
    MovieClip = PIXI.extras.MovieClip,
    Sprite = PIXI.Sprite;


let stage = new Container(),
     renderer = new PIXI.CanvasRenderer(640,1138); 
document.body.appendChild(renderer.view);

renderer.backgroundColor = 0x191970;

// 
let state = play;
let sceneState = inner;
let pre_sceneState = inner;

//scenes
let city,world,chatStyle;
let res_outmap,res_innerui,res_outerui;

let su,scale,t,b,background,idz,pixie,pixim,res_mainui,vx,vy;

let innerBtns={};
let innerBtn_bottom_left,innerBtn_chat,innerBtn_bottom_right;

let outerBtns={};
let outerBtn_bottom_left,outerBtn_chat,outerBtn_bottom_right;

let innerSel;
// (initallbtninfo());
inituis();

//js 生成动态全局对象
//http://duanmubuzhi.iteye.com/blog/1869827

//touch click   点击事件穿透
//http://www.tuicool.com/articles/6NfaUnM
// http://www.cnblogs.com/yexiaochai/p/3462657.html
//http://www.cnblogs.com/yexiaochai/p/3442220.html

 

loader
    .add("images/zs.json")//僵尸-帧
    .add("background","images/Mooji_preview11.png")//内城-底图
    .add("chatbackground","images/Mooji_Kraft_Paper_Bottom.png")//聊天-底图
    .add("images/mainui.json",function(res)//UI-帧
    {
      res_mainui = res.textures
    })
    .add('images/sewers.json', function(res)//世界-地图
    {
        res_outmap = res.tiledMap;
    })
    .on("progress", loadProgressHandler)
    .load(setup);

function loadProgressHandler(loader, resource) {
  console.log("loading: " + resource.url+"  /  "+ resource.name); 
  console.log("progress: " + loader.progress + "%"); 
}

function setup() {
    // su = new SpriteUtilities(PIXI);
    scale = scaleToWindow(renderer.view);
    t = new Tink(PIXI,renderer.view,scale);
    // b = new Bump(PIXI);

    pointer = t.makePointer();
    // pointer.press = ()=>{

    // };
    // pointer.release = ()=>{

    // };
    // pointer.tap = ()=>{

    // };
   

//outerScene
    world = new Container();
    initOuterSceneUI();
    stage.addChild(world);

//innerScene
    city = new Container();
    initInnerSceneUI();
    stage.addChild(city);

//UIAct
    innerui = new Container();
    stage.addChild(innerui);
    for(let layername in uidata){
      let layer = uidata[layername]
      for(let prop in layer){
          uibtnact(this[prop],prop,layer[prop]);
      }
    }

//pub
    //  pointer.x = pointer.x / scale;
    //  pointer.y = pointer.y / scale;
    window.addEventListener("resize",event => {
      scaleToWindow(renderer.view);
    });
    t.makeDraggable(background);

//聊天
    chatStyle = new Container();
    initChatUI();
    stage.addChild(chatStyle);
    chatStyle.visible = false;

    
//商品-待优化
    goodsObject();
    goodsStyle = new Container();

    goodsBar = new PIXI.Sprite(resources.chatbackground.texture);//商品底图
    goodsStyle.addChild(goodsBar);

    goodsStyle.addChild(itemsGroup);
    itemsGroup.position.y = 40;

    let goodsClose = new Sprite(res_mainui["Mooji_Ui_Close_Button.png"]);//商品退出
    goodsClose.position.x = renderer.width-goodsClose.width-20;
    goodsClose.interactive = true;
    goodsClose.buttonMode = true;
    // goodsClose.click = function(data){//商品-退出事件
    //   sceneState = pre_sceneState;
    // }
    goodsClose.mousedown = function(data){
      goodsClose.scale.x += 0.1;
      goodsClose.scale.y += 0.1;
    }
    goodsClose.mouseup = function(data){
      goodsClose.scale.x -= 0.1;
      goodsClose.scale.y -= 0.1;
      sceneState = pre_sceneState;
    }
    goodsStyle.addChild(goodsClose);

    let goodsTitle = new PIXI.Text("Items",{fontSize:"50px Arial",fill:"yellow"});
    goodsTitle.position.x = renderer.width/2 - goodsTitle.width/2;
    goodsStyle.addChild(goodsTitle);
    stage.addChild(goodsStyle);
    goodsStyle.visible = false;


//uiText
    initUITextUI();

//GameLoop  
    loop();

}

function loop() {

    requestAnimationFrame(loop);
    t.update();
    sceneState();
    state();
    // state = end;
    renderer.render(stage);
}

function inner(){
  innerui.visible = true;
  city.visible = true;
  goodsStyle.visible = false;
  background.draggable  = true;
  document.getElementById('chatDiv').style.display = "none";
  world.visible = false;
  chatStyle.visible = false;
  contain(background, {x: (renderer.width-background.width), y: (renderer.height-background.height), width: background.width, height: background.height});
}

function outer(){
  innerui.visible = true;
  city.visible = false;
  world.visible = true;
  goodsStyle.visible = false;
  chatStyle.visible = false;
  res_outmap.draggable  = true;
  document.getElementById('chatDiv').style.display = "none";
  contain(res_outmap, {x: (renderer.width-res_outmap.width), y: (renderer.height-res_outmap.height), width: res_outmap.width, height: res_outmap.height});
}

function chat(){
  innerui.visible = false;
  chatStyle.visible = true;
  city.visible = false;
  world.visible = false;
  background.draggable  = false;
  res_outmap.draggable  = false;
  document.getElementById('chatDiv').style.display = "";
  document.getElementById('chatDiv').style.position = "absolute";
  // relative,absolute

  // console.log(renderer.view);
  // console.log(renderer.view.getBoundingClientRect());
  // console.log(renderer.view.style.transform);
  // console.log(scale);

  //   console.log(renderCanvas.height+"/"+renderCanvas.top+"/"+renderCanvas.y+"===="+(renderer.width/renderCanvas.width));
  // console.log(renderer.view.style.transform+"========"+scale);
  // http://bbs.csdn.net/topics/391807741?page=1 *(renderer.width/renderCanvas.width)

  //缩放存在问题--待后续处理
  let renderCanvas = renderer.view.getBoundingClientRect();
  // document.getElementById('chatDiv').style.left = (renderCanvas.left+chatInputBefore.width)+"px";
  // document.getElementById('chatDiv').style.top = (renderCanvas.height - chatInputBefore.width/2)+"px";

  document.getElementById('chatDiv').style.left = 100+"px";
  document.getElementById('chatDiv').style.top = 1038+"px";

  contain(chatsGroup, {x: 620, y: (renderer.height-chatsGroup.height-320), width: 620, height: chatsGroup.height+320});
    
}

function goods(){
    innerui.visible = false;
    goodsStyle.visible = true;
    chatStyle.visible = false;
    city.visible = false;
    world.visible = false;
    background.draggable  = false;
    res_outmap.draggable  = false;  
    document.getElementById('chatDiv').style.display = "none";
    contain(itemsGroup, {x: 620, y: (renderer.height-itemsGroup.height-320), width: 620, height: itemsGroup.height+40});
    
}

function play() {
    if (city.visible){

      if (innerSel){
      innerSel.x += innerSel.vx;
      innerSel.y += innerSel.vy;
      contain(innerSel, {x: 0, y: 0, width: 4096, height: 4096});
      }
    }else if(world.visible){
      pixim.x += pixim.vx;
      pixim.y += pixim.vy;
      contain(pixim, {x: 0, y: 0, width: 4096, height: 4096});
    }
}

function end(){
  //  stage.visible = false;
}

function reset(){
    //
}

// function wait(duration = 0){
//   return new Promise(resolve,reject)=>{
//     setTimeOut(resolve,duration);
//   });
// }






</script>

<style>
.input_search { width:399px;  border:0px;  font-size:19px; color:white; background:transparent; }
</style>

<div id="chatDiv" style="display:">
<font color="yellow">INPUT:</font><input  id="chatInput" class="input_search"  maxlength="140">
</div>




</body>